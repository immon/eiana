<process-definition name="Domain Modification Transaction (Unified Workflow)">

    <start-state>
        <transition to="PENDING_CONTACT_CONFIRMATION"></transition>
    </start-state>

    <state name="PENDING_CONTACT_CONFIRMATION">
        <event type='node-enter'>
            <action class="org.iana.rzm.trans.jbpm.handlers.RoleCalculator">
                <roles>
                    <element>IANA</element>
                </roles>
            </action>
            <action class="org.iana.rzm.trans.jbpm.handlers.ContactConfirmationCalculator"/>
            <action class="org.iana.rzm.trans.jbpm.handlers.ContactNotifier">
                <notification>contact-confirmation</notification>
            </action>
        </event>
        <timer name="7d-time-out" duedate='7 days'>
            <action class="org.iana.rzm.trans.jbpm.handlers.ContactConfirmationRemainder">
                <period>23</period>
                <notification>contact-confirmation-remainder</notification>
            </action>
        </timer>
        <timer name="14d-time-out" duedate='14 days'>
            <action class="org.iana.rzm.trans.jbpm.handlers.ContactConfirmationRemainder">
                <period>16</period>
                <notification>contact-confirmation-remainder</notification>
            </action>
        </timer>
        <timer name="21d-time-out" duedate='21 days'>
            <action class="org.iana.rzm.trans.jbpm.handlers.ContactConfirmationRemainder">
                <period>9</period>
                <notification>contact-confirmation-remainder</notification>
            </action>
        </timer>
        <timer name="30d-time-out" duedate='30 days' transition='close'></timer>
        <transition name="accept" to="PENDING_TECH_CHECK"/>
        <transition name="reject" to="REJECTED"/>
        <transition name="admin-accept" to="PENDING_TECH_CHECK"/>
        <transition name="admin-reject" to="REJECTED"/>
        <transition name="close" to="ADMIN_CLOSED"/>
    </state>

    <decision name="PENDING_TECH_CHECK">
        <handler class="org.iana.rzm.trans.jbpm.handlers.TechnicalCheckDecision">
            <test>true</test>
        </handler>
        <transition name="no-test" to="PENDING_IMPACTED_PARTIES"/>
        <transition name="test-ok" to="PENDING_IMPACTED_PARTIES"/>
        <!--
                todo: future feature
                <transition name="test-failed" to="PENDING_TECH_CHECK_REMEDY"/>
        -->
    </decision>

    <state name="PENDING_IMPACTED_PARTIES">
        <event type='node-enter'>
            <action class="org.iana.rzm.trans.jbpm.handlers.RoleCalculator">
                <roles>
                    <element>IANA</element>
                </roles>
            </action>
            <action class="org.iana.rzm.trans.jbpm.handlers.ImpactedPartiesCalculator"/>
            <action class="org.iana.rzm.trans.jbpm.handlers.ImpactedPartiesNotifier">
                <notification>impacted_parties-confirmation</notification>
            </action>
        </event>
        <timer name="7d-time-out" duedate='7 days'>
            <action class="org.iana.rzm.trans.jbpm.handlers.ImpactedPartiesConfirmationRemainder">
                <period>23</period>
                <notification>impacted_parties-confirmation-remainder</notification>
            </action>
        </timer>
        <timer name="14d-time-out" duedate='14 days'>
            <action class="org.iana.rzm.trans.jbpm.handlers.ImpactedPartiesConfirmationRemainder">
                <period>16</period>
                <notification>impacted_parties-confirmation-remainder</notification>
            </action>
        </timer>
        <timer name="21d-time-out" duedate='21 days'>
            <action class="org.iana.rzm.trans.jbpm.handlers.ImpactedPartiesConfirmationRemainder">
                <period>9</period>
                <notification>impacted_parties-confirmation-remainder</notification>
            </action>
        </timer>
        <timer name="30d-time-out" duedate='30 days' transition='close'></timer>
        <transition name="accept" to="PENDING_IANA_CONFIRMATION"/>
        <transition name="reject" to="REJECTED"/>
        <transition name="admin-accept" to="PENDING_IANA_CONFIRMATION"/>
        <transition name="admin-reject" to="REJECTED"/>
        <transition name="admin-back" to="PENDING_CONTACT_CONFIRMATION" />
        <transition name="close" to="ADMIN_CLOSED"/>
    </state>

    <state name="PENDING_IANA_CONFIRMATION">
        <event type='node-enter'>
            <action class="org.iana.rzm.trans.jbpm.handlers.RoleCalculator">
                <roles>
                    <element>IANA</element>
                </roles>
            </action>
        </event>
        <timer name="3d-time-out" duedate='3 days' transition='alert'></timer>
        <transition name="normal" to="PENDING_EXT_APPROVAL"/>
        <transition name="alert" to="EXCEPTION"/>
        <transition name="admin-accept" to="PENDING_EXT_APPROVAL"/>
        <transition name="admin-back" to="PENDING_IMPACTED_PARTIES" />
        <!--
                todo: future feature
                <transition name="redelegation" to="PENDING_EVALUATION"/>
        -->
    </state>

    <state name="PENDING_EXT_APPROVAL">
        <event type='node-enter'>
            <action class="org.iana.rzm.trans.jbpm.handlers.RoleCalculator">
                <roles>
                    <element>IANA</element>
                </roles>
            </action>
            <action class="org.iana.rzm.trans.jbpm.handlers.RoleConfirmationCalculator">
                <roles>
                    <element>IANA</element>
                </roles>
            </action>
        </event>
        <timer name="30d-time-out" duedate='30 days' transition='alert'></timer>
        <transition name="accept" to="PENDING_USDOC_APPROVAL"/>
        <transition name="reject" to="REJECTED"/>
        <transition name="admin-accept" to="PENDING_USDOC_APPROVAL"/>
        <transition name="admin-reject" to="REJECTED"/>
        <transition name="admin-back" to="PENDING_IANA_CONFIRMATION" />
        <transition name="close" to="ADMIN_CLOSED"/>
        <transition name="alert" to="EXCEPTION"/>
    </state>

    <state name="PENDING_USDOC_APPROVAL">
        <event type='node-enter'>
            <action class="org.iana.rzm.trans.jbpm.handlers.RoleCalculator">
                <roles>
                    <element>IANA</element>
                </roles>
            </action>
            <action class="org.iana.rzm.trans.jbpm.handlers.RoleCalculator">
                <roles>
                    <element>USDoC</element>
                </roles>
            </action>
            <action class="org.iana.rzm.trans.jbpm.handlers.RoleConfirmationCalculator">
                <roles>
                    <element>USDoC</element>
                </roles>
            </action>
        </event>
        <timer name="5d-time-out" duedate='5 days'>
            <action class="org.iana.rzm.trans.jbpm.handlers.USDOCConfirmationRemainder">
                <period>9</period>
                <notification>uscdoc-confirmation-remainder</notification>
            </action>
        </timer>
        <timer name="14d-time-out" duedate='14 days' transition='alert'></timer>
        <transition name="accept" to="USDOC_APPROVED"/>
        <transition name="reject" to="REJECTED"/>
        <transition name="admin-accept" to="USDOC_APPROVED"/>
        <transition name="admin-reject" to="REJECTED"/>
        <transition name="admin-back" to="PENDING_EXT_APPROVAL" />
        <transition name="alert" to="EXCEPTION"/>
    </state>

    <decision name="USDOC_APPROVED">
        <handler class="org.iana.rzm.trans.jbpm.handlers.NameServerChange"/>
        <transition name="no-ns-change" to="PENDING_DATABASE_INSERTION"/>
        <transition name="ns-change" to="PENDING_ZONE_INSERTION"/>
    </decision>

    <state name="PENDING_ZONE_INSERTION">
        <event type="node-enter">
            <action class="org.iana.rzm.trans.jbpm.handlers.ZoneInsertionAction">
            </action>
            <action class="org.iana.rzm.trans.jbpm.handlers.RoleCalculator">
                <roles>
                    <element>IANA</element>
                </roles>
            </action>
            <action class="org.iana.rzm.trans.jbpm.handlers.RoleConfirmationCalculator">
                <roles>
                    <element>IANA</element>
                </roles>
            </action>
        </event>
        <timer name="7d-time-out" duedate="7 days">
            <action class="org.iana.rzm.trans.jbpm.handlers.ZoneInsertionAlert">
                <period>7</period>
                <notification>zone-insertion-alert</notification>
            </action>
        </timer>
        <timer name="14d-time-out" duedate="14 days" transition="alert"></timer>
        <transition name="accept" to="PENDING_ZONE_PUBLICATION"/>
        <transition name="admin-accept" to="PENDING_ZONE_PUBLICATION"/>
        <transition name="admin-back" to="PENDING_USDOC_APPROVAL" />
        <transition name="alert" to="EXCEPTION"/>
    </state>

    <state name="PENDING_ZONE_PUBLICATION">
        <event type="node-enter">
            <action class="org.iana.rzm.trans.jbpm.handlers.ZonePublicationAction">
            </action>
            <action class="org.iana.rzm.trans.jbpm.handlers.RoleCalculator">
                <roles>
                    <element>IANA</element>
                </roles>
            </action>
            <action class="org.iana.rzm.trans.jbpm.handlers.RoleConfirmationCalculator">
                <roles>
                    <element>IANA</element>
                </roles>
            </action>
        </event>
        <timer name="3d-time-out" duedate="3 days">
            <action class="org.iana.rzm.trans.jbpm.handlers.ZonePublicationAlert">
                <period>4</period>
                <notification>zone-publication-alert</notification>
            </action>
        </timer>
        <timer name="7d-time-out" duedate="7 days" transition="alert"></timer>
        <transition name="accept" to="PENDING_DATABASE_INSERTION"/>
        <transition name="admin-accept" to="PENDING_DATABASE_INSERTION"/>
        <transition name="admin-back" to="PENDING_ZONE_INSERTION" />
        <transition name="alert" to="EXCEPTION"/>
    </state>

    <node name='PENDING_DATABASE_INSERTION'>
        <event type='node-enter'>
            <action class='org.iana.rzm.trans.jbpm.handlers.UpdateDomainAction'/>
        </event>
        <transition name='complete' to='COMPLETED'>
        </transition>
    </node>

    <end-state name='COMPLETED'>
        <event type='node-enter'>
            <action class='org.iana.rzm.trans.jbpm.handlers.ProcessStateNotifier'>
                <notification>completed</notification>
            </action>
        </event>
    </end-state>

    <end-state name='REJECTED'>
        <event type='node-enter'>
            <action class='org.iana.rzm.trans.jbpm.handlers.ProcessStateNotifier'>
                <notification>rejected</notification>
            </action>
        </event>
    </end-state>

    <end-state name='WITHDRAWN'>
        <event type='node-enter'>
            <action class='org.iana.rzm.trans.jbpm.handlers.ProcessStateNotifier'>
                <notification>withdrawn</notification>
            </action>
        </event>
    </end-state>

    <end-state name='ADMIN_CLOSED'>
        <event type='node-enter'>
            <action class='org.iana.rzm.trans.jbpm.handlers.ProcessStateNotifier'>
                <notification>admin-closed</notification>
            </action>
        </event>
    </end-state>

    <state name='EXCEPTION'>
        <event type='node-enter'>
            <action class='org.iana.rzm.trans.jbpm.handlers.ProcessStateNotifier'>
                <notification>exception</notification>
            </action>
        </event>
        <!-- manual transition allowed -->
    </state>
</process-definition>